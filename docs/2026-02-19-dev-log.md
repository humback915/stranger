# 개발 로그 - 2026-02-19

## Hello, Stranger — 블라인드 데이팅 앱

---

## 구현 내용 요약

오늘 총 **6개 기능 그룹** 구현 + **로컬 테스트 및 버그 수정**을 진행했습니다.

---

## Phase 1: 매칭 만료 자동 처리

### 변경 파일
- `supabase/migrations/00022_add_match_expiry.sql` (신규)
- `src/actions/matching.ts` (수정)
- `src/app/api/cron/expire-matches/route.ts` (신규)
- `src/middleware.ts` (수정)
- `src/types/database.ts` (수정)

### 내용
- `matches` 테이블에 `expires_at TIMESTAMPTZ` 컬럼 추가
- 기존 데이터 `expires_at = created_at + 7일` 마이그레이션
- `notifications.type` CHECK 제약에 `match_expired` 추가
- `runMatching()` INSERT 시 `expires_at` 자동 계산 포함
- `/api/cron/expire-matches` 크론 엔드포인트: `pending` 상태 + `expires_at < now()` 매칭을 `expired`로 일괄 처리, 양쪽 사용자에게 알림
- 미들웨어에 `/api/cron/*` 경로 통과 허용 추가

---

## Phase 2: 실시간 채팅 기능

### 변경 파일
- `supabase/migrations/00023_create_messages.sql` (신규)
- `supabase/migrations/00024_enable_messages_realtime.sql` (신규)
- `src/actions/chat.ts` (신규)
- `src/app/(main)/matches/[id]/chat/page.tsx` (신규)
- `src/components/chat/ChatWindow.tsx` (신규)
- `src/components/chat/ChatInput.tsx` (신규)
- `src/components/matches/MatchCard.tsx` (수정)
- `src/lib/constants/routes.ts` (수정)
- `src/types/database.ts` (수정)

### 내용
- `messages` 테이블 생성 (RLS 적용: 조회는 accepted+completed, 전송은 accepted만)
- Supabase Realtime publication에 `messages` 테이블 추가
- `getMessages()`, `sendMessage()`, `markChatAsRead()` 서버 액션 구현
- `/matches/[id]/chat` 채팅 페이지 (서버 컴포넌트, 권한 검증)
- `ChatWindow`: Supabase Realtime `postgres_changes` 구독으로 실시간 수신
  - 내 메시지 우측, 상대 메시지 좌측 렌더링
  - 새 메시지 도착 시 자동 스크롤 + 읽음 처리
- `ChatInput`: Enter 전송, Shift+Enter 줄바꿈, 500자 제한
- `MatchCard`에 `status === "accepted"` 시 "채팅하기" 버튼 추가

---

## Phase 3: 노쇼 자동 처리 + 미션 완료 자동 처리 + 채팅 푸시 알림

### 변경 파일
- `supabase/migrations/00025_add_no_show_notification_type.sql` (신규)
- `src/app/api/cron/no-show/route.ts` (신규)
- `src/actions/mission.ts` (수정)
- `src/actions/chat.ts` (수정)
- `src/actions/notification.ts` (수정)
- `src/lib/cron-auth.ts` (신규)
- `vercel.json` (신규)
- `src/types/database.ts` (수정)

### 내용
- **노쇼 크론** (`/api/cron/no-show`, 10분마다): 기한 지난 미응답 `no_show_checks` → `no_show` 처리, `no_show_count` 증가, 3회 이상 시 계정 정지, 영향받은 미션 `cancelled`
- **미션 완료 자동 처리**: 양쪽 모두 `confirmed` 시 `confirmDeparture()` 내에서 미션 → `completed`, 매칭 → `completed` 자동 업데이트
- **채팅 푸시 알림**: `sendMessage()` 호출 시 상대방에게 FCM 푸시 알림 자동 전송
- **`isCronAuthorized()` 헬퍼**: `?secret=` 쿼리 파라미터 + `Authorization: Bearer` 헤더 양쪽 모두 지원
- **`vercel.json`**: Vercel Cron 스케줄 설정
  ```json
  { "path": "/api/cron/expire-matches", "schedule": "0 2 * * *" },
  { "path": "/api/cron/no-show", "schedule": "*/10 * * * *" },
  { "path": "/api/push/departure-reminder", "schedule": "*/10 * * * *" }
  ```

---

## Phase 4: Vercel Cron 설정 + 프로필 수정 개선

### 변경 파일
- `src/app/(main)/settings/SettingsClient.tsx` (수정)

### 내용
- 닉네임 수정 폼 추가
- 매칭 상태 토글 (활성 ↔ 일시정지) 슬라이드 버튼

---

## Phase 5: 사진 수정 기능 + 신고 기능 UI

### 변경 파일
- `src/components/profile/PhotoEditor.tsx` (신규)
- `src/components/safety/ReportModal.tsx` (신규)
- `src/app/(main)/settings/SettingsClient.tsx` (수정)
- `src/components/mission/MissionCard.tsx` (수정)

### 내용
- **PhotoEditor**: 프로필 사진 업로드/삭제/저장
  - 최소 2장, 최대 5장, 파일당 5MB 제한
  - 첫 번째 사진 "대표" 뱃지 표시
  - Supabase Storage 연동
- **ReportModal**: 바텀 시트 신고 모달
  - 신고 유형 5종 (성희롱/부적절한 언행, 불건전한 콘텐츠, 노쇼, 안전 위협, 기타)
  - 설명 텍스트에어리어 (최대 500자, 선택)
  - 신고 완료 후 1.5초 체크 애니메이션 → 자동 닫힘
- 설정 페이지에 사진 관리 섹션 + PhotoEditor 연동
- MissionCard에 신고 버튼 + ReportModal 연동

---

## Phase 6: 채팅 미읽음 배지 + 채팅 미리보기

### 변경 파일
- `supabase/migrations/00026_create_match_read_cursors.sql` (신규)
- `src/actions/chat.ts` (수정 — `markChatAsRead`)
- `src/actions/matching.ts` (수정 — `getMyMatches` 확장)
- `src/components/matches/MatchCard.tsx` (수정)
- `src/app/(main)/matches/MatchesClient.tsx` (수정)
- `src/types/database.ts` (수정)

### 내용
- **`match_read_cursors` 테이블**: 유저별 매칭별 마지막 읽음 시각 추적 (upsert 패턴)
- **미읽음 배지**: MatchCard 채팅 버튼에 빨간 원형 배지 (9+ overflow)
- **채팅 미리보기**: 매칭 목록에서 마지막 메시지 미리보기 (내 메시지는 "나:" 접두어)
- `getMyMatches()`에서 `accepted` 매칭마다 `lastMessage`, `unreadCount` 병렬 조회

---

## 발생한 오류 및 해결

| 오류 | 원인 | 해결 |
|------|------|------|
| `Set<number>` iteration TS 에러 | TypeScript target이 ES2015 Set iteration 미지원 | `Array.from(noShowMissionIds)` 로 변환 |
| 알림 type union 불일치 | `NotificationsClient.tsx`에 구형 타입 정의 | `Notification` 인터페이스에 `"match_expired" \| "no_show"` 추가 |

---

## Phase 7: 로컬 테스트 + 버그 수정

### 테스트 내용

로컬 dev 환경(`supabase start` + `npm run dev`)에서 크론 API, DB 상태, 실시간 채팅 등을 직접 검증했습니다.

#### 크론 API 테스트 결과 (curl)

| 엔드포인트 | 결과 |
|------------|------|
| `POST /api/cron/no-show?secret=...` | `{"processed":2}` — no_show_checks 2건 처리, 미션 cancelled, 알림 생성 ✅ |
| `POST /api/cron/expire-matches?secret=...` | `{"processed":1}` — 만료 pending 매칭 expired 처리, 양쪽 알림 생성 ✅ |
| 인증 없이 접근 | `401 Unauthorized` 정상 반환 ✅ |

#### DB 상태 검증

- `messages` 테이블: 실사용 메시지 2건 존재, 스키마 정상
- `match_read_cursors`: 양쪽 유저 커서 정상 기록
- `notifications` 신규 타입 (`match_expired`, `no_show`) CHECK 제약 통과
- TypeScript 타입 체크(`npx tsc --noEmit`) 통과

### 발견된 버그 3건 수정

#### 버그 1: 실시간 채팅 수신 안 됨
- **증상**: 상대방 메시지가 새로고침 없이 표시되지 않음
- **원인**: `postgres_changes` 구독 시 Supabase Realtime WebSocket 연결에 유저 JWT를 명시적으로 설정하지 않아, Realtime 서버가 RLS 체크를 위한 권한을 확인하지 못함
- **해결** (`ChatWindow.tsx`):
  ```ts
  // 구독 전 세션 토큰을 Realtime 연결에 주입
  const { data: { session } } = await supabase.auth.getSession();
  if (session?.access_token) {
    supabase.realtime.setAuth(session.access_token);
  }
  ```
  채널 생성을 async 함수로 감싸 토큰 설정 후 subscribe 하도록 순서 보장

#### 버그 2: 알림 모두 읽음 처리 동작 안 됨
- **증상**: "모두 읽음 처리" 버튼 클릭 시 UI에 반영되지 않음
- **원인 1**: `notifications` UPDATE RLS 정책에 `WITH CHECK` 절이 없어 일부 PostgREST 버전에서 갱신 거부
- **원인 2**: 서버 액션 실패 시 에러 피드백이 없어 무음 실패
- **해결**:
  - `supabase/migrations/00027_fix_notifications_rls.sql`: UPDATE 정책에 `WITH CHECK (user_id = auth.uid())` 추가
  - `NotificationsClient.tsx`: 에러 메시지 표시, "처리 중..." 상태 표시 추가

#### 버그 3: 채팅 상단바에 상대 정보 없음
- **증상**: 채팅 페이지 헤더에 "채팅 / 매칭 #1"만 표시
- **원인**: 서버 컴포넌트에서 파트너 프로필을 조회하지 않았음
- **해결** (`chat/page.tsx`): `profiles` 테이블에서 파트너 `nickname`, `gender` 조회 후 헤더에 표시

### 변경 파일
- `supabase/migrations/00027_fix_notifications_rls.sql` (신규)
- `src/components/chat/ChatWindow.tsx` (수정 — realtime setAuth)
- `src/app/(main)/matches/[id]/chat/page.tsx` (수정 — 파트너 닉네임 헤더)
- `src/app/(main)/notifications/NotificationsClient.tsx` (수정 — 에러 피드백)

---

## 현재 남은 작업

- [ ] **매칭 재신청**: `expired`/`rejected` 상태에서 재매칭 요청 버튼
- [ ] **미션 없는 accepted 매칭 안내**: AI 미션 생성 실패 시 안내 UI
- [ ] **E2E 타입 동기화**: `supabase gen types` npm script 추가
- [ ] **홈 화면 고도화**: 매칭/미션 현황 대시보드 카드

---

## 커밋 히스토리 (오늘)

```
fix: 실시간 채팅 수신, 알림 모두 읽음, 채팅 상단바 버그 3건 수정
feat: 채팅 미읽음 배지 + 매칭 페이지 채팅 미리보기
feat: 사진 수정 기능 + 신고 기능 UI
feat: Vercel Cron 설정 + 프로필 닉네임/매칭상태 수정
feat: 노쇼 자동 처리 크론 + 미션 완료 자동 처리 + 채팅 푸시 알림
feat: 매칭 만료 자동 처리 + Supabase Realtime 채팅
```
