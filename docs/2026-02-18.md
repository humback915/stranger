# 2026-02-18 작업 일지

## 개요

4대 기능 구현 완료: Google Maps 연동, 관리자 대시보드, OpenAI 연동, 푸시 알림(FCM)

---

## 1. Google Maps 연동

**설치:** `@vis.gl/react-google-maps`

| 파일 | 변경 | 설명 |
|------|------|------|
| `src/components/mission/MissionMap.tsx` | 신규 | 지도 + 마커 + 길찾기 링크 (API 키 없으면 텍스트 링크 폴백) |
| `src/components/mission/MissionCard.tsx` | 수정 | MissionMap 삽입, `place_lat`/`place_lng` props 추가 |
| `src/__tests__/components/MissionCard.test.tsx` | 수정 | MissionMap 목 추가, `place_lat`/`place_lng` 테스트 데이터 추가 |

**핵심:**
- `NEXT_PUBLIC_GOOGLE_MAPS_API_KEY` 있으면 다크 테마 지도 렌더링 (`h-48`)
- 키 없으면 "Google Maps에서 길찾기" 텍스트 링크로 graceful fallback
- 하단에 항상 길찾기 링크 표시

---

## 2. 관리자 대시보드

**마이그레이션:** `00019_add_admin_role.sql` — `profiles.is_admin BOOLEAN DEFAULT false`

| 파일 | 변경 | 설명 |
|------|------|------|
| `supabase/migrations/00019_add_admin_role.sql` | 신규 | `is_admin` 컬럼 추가 |
| `src/lib/supabase/admin.ts` | 신규 | service_role 키 사용하는 어드민 클라이언트 (RLS 우회) |
| `src/actions/admin.ts` | 신규 | `requireAdmin()`, `getAdminStats()`, `getReports()`, `updateReportStatus()`, `getUsers()`, `banUser()`, `unbanUser()`, `getNoShows()` |
| `src/app/(admin)/admin/layout.tsx` | 신규 | 어드민 레이아웃 (is_admin 체크, 상단 네비, 미인가 시 /home 리다이렉트) |
| `src/app/(admin)/admin/page.tsx` | 신규 | 통계 대시보드 (유저/매칭/미션/신고 카운트) |
| `src/app/(admin)/admin/reports/page.tsx` | 신규 | 신고 관리 서버 페이지 |
| `src/app/(admin)/admin/reports/ReportsClient.tsx` | 신규 | 신고 관리 클라이언트 (필터, 상태 변경) |
| `src/app/(admin)/admin/users/page.tsx` | 신규 | 사용자 관리 서버 페이지 |
| `src/app/(admin)/admin/users/UsersClient.tsx` | 신규 | 사용자 관리 클라이언트 (검색, ban/unban) |
| `src/app/(admin)/admin/no-shows/page.tsx` | 신규 | 노쇼 현황 |
| `src/types/database.ts` | 수정 | profiles Row/Insert/Update에 `is_admin` 추가 |
| `src/lib/constants/routes.ts` | 수정 | `ADMIN.ROOT`, `ADMIN.REPORTS`, `ADMIN.USERS`, `ADMIN.NO_SHOWS` 추가 |
| `src/middleware.ts` | 수정 | `/admin` 경로는 프로필 체크 스킵 (자체 인증) |

**핵심:**
- `(admin)` 라우트 그룹으로 메인 앱과 레이아웃 분리
- layout에서 `requireAdmin()` → `is_admin = false`면 `/home` 리다이렉트
- 모든 어드민 쿼리는 service_role 클라이언트로 RLS 우회
- DB에서 수동으로 `UPDATE profiles SET is_admin = true WHERE ...` 설정

---

## 3. OpenAI 연동

**설치:** `openai`

**마이그레이션:** `00020_add_ai_fields.sql`
- `matches.ai_description TEXT`
- `missions.ai_place_rationale TEXT`
- `missions.ai_prop_rationale_a TEXT`
- `missions.ai_prop_rationale_b TEXT`

| 파일 | 변경 | 설명 |
|------|------|------|
| `supabase/migrations/00020_add_ai_fields.sql` | 신규 | AI 필드 4개 추가 |
| `src/lib/openai.ts` | 신규 | OpenAI 클라이언트 싱글톤 (키 없으면 null 반환) |
| `src/actions/ai.ts` | 신규 | `generateMatchDescription()` (호환성 2-3문장), `generateAIMission()` (JSON 모드 + 허용 목록 검증) |
| `src/actions/matching.ts` | 수정 | `runMatching()`: 매칭 후 AI 설명 생성 → `ai_description` 저장 |
| `src/actions/matching.ts` | 수정 | `getMyMatches()`: select에 `ai_description` 추가 |
| `src/actions/matching.ts` | 수정 | `generateMission()`: AI 미션 생성 시도 → 실패 시 기존 랜덤 폴백 |
| `src/actions/mission.ts` | 수정 | `getMission()`: select에 AI 필드 3개 추가 |
| `src/components/matches/MatchCard.tsx` | 수정 | `ai_description` props 추가, AI 호환성 분석 섹션 표시 |
| `src/components/mission/MissionCard.tsx` | 수정 | AI 필드 props 추가, 장소/소품 선택 이유 표시 |
| `src/types/database.ts` | 수정 | matches에 `ai_description`, missions에 AI 필드 3개 추가 |

**핵심:**
- 모델: `gpt-4o-mini` (빠르고 저렴)
- **AI-enhance, random-fallback** 패턴: AI 실패해도 기존 기능 정상 작동
- `generateAIMission()`: JSON 모드로 미션 생성, 응답을 허용 목록과 교차 검증
- `OPENAI_API_KEY` 없으면 AI 기능 자동 스킵

---

## 4. 푸시 알림 (FCM)

**설치:** `firebase`, `firebase-admin`

**마이그레이션:** `00021_create_push_subscriptions.sql`
- `push_subscriptions` 테이블 (user_id, fcm_token, device_info, UNIQUE(user_id, fcm_token))
- RLS 정책 + 인덱스

| 파일 | 변경 | 설명 |
|------|------|------|
| `supabase/migrations/00021_create_push_subscriptions.sql` | 신규 | push_subscriptions 테이블 + RLS + 인덱스 |
| `public/firebase-messaging-sw.js` | 신규 | 백그라운드 푸시 수신 Service Worker |
| `src/lib/firebase/client.ts` | 신규 | 클라이언트 Firebase 초기화 + `requestPushToken()` + `onForegroundMessage()` |
| `src/lib/firebase/admin.ts` | 신규 | 서버 Firebase Admin 초기화 + `getAdminMessaging()` |
| `src/actions/push.ts` | 신규 | `savePushSubscription()`, `removePushSubscription()`, `sendPushToUser()` (만료 토큰 자동 정리) |
| `src/components/push/PushNotificationManager.tsx` | 신규 | 로그인 시 자동 푸시 등록 + SW 등록 + 포그라운드 메시지 처리 |
| `src/app/api/push/departure-reminder/route.ts` | 신규 | 출발 1시간 전 리마인더 크론 엔드포인트 (CRON_SECRET 인증) |
| `src/actions/notification.ts` | 수정 | `createNotification()` 마지막에 `sendPushToUser()` 호출 (dynamic import) |
| `src/app/(main)/layout.tsx` | 수정 | `PushNotificationManager` 추가 |
| `src/middleware.ts` | 수정 | `/api/push` 경로 통과 허용 |
| `next.config.mjs` | 수정 | Service Worker 헤더 설정 (`Service-Worker-Allowed`, `Cache-Control`) |
| `.env.example` | 수정 | Firebase 환경변수 11개 추가 (클라이언트 5 + 어드민 3 + VAPID 1 + CRON 1) |
| `src/types/database.ts` | 수정 | `push_subscriptions` 타입 추가 |

**핵심:**
- 멀티 디바이스 지원 (user당 여러 FCM 토큰)
- 만료된 토큰 자동 정리 (`messaging/registration-token-not-registered`)
- Firebase 미설정 시 graceful skip (기존 폴링 방식 유지)
- 출발 리마인더: 크론 10분 간격으로 체크, `CRON_SECRET`으로 엔드포인트 보호

---

## 빌드 검증

- `npx tsc --noEmit` — 통과
- `pnpm build` — 통과 (28 페이지, 경고 2개: `<img>` → `<Image />` 미사용 기존 코드)

---

## 환경변수 추가 목록 (.env.example)

```env
# Google Maps (기존)
NEXT_PUBLIC_GOOGLE_MAPS_API_KEY=

# OpenAI (기존)
OPENAI_API_KEY=

# Firebase 클라이언트 (신규)
NEXT_PUBLIC_FIREBASE_API_KEY=
NEXT_PUBLIC_FIREBASE_PROJECT_ID=
NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=
NEXT_PUBLIC_FIREBASE_APP_ID=
NEXT_PUBLIC_FIREBASE_VAPID_KEY=

# Firebase Admin (신규)
FIREBASE_ADMIN_PROJECT_ID=
FIREBASE_ADMIN_CLIENT_EMAIL=
FIREBASE_ADMIN_PRIVATE_KEY=

# 크론 시크릿 (신규)
CRON_SECRET=
```

---

## 마이그레이션 적용

```bash
supabase migration up
# 00019_add_admin_role.sql
# 00020_add_ai_fields.sql
# 00021_create_push_subscriptions.sql
```
