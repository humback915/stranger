# 개발 로그 - 2026-02-22

## Hello, Stranger — 블라인드 데이팅 앱

---

## 작업 요약

오늘은 크게 두 가지를 진행했습니다.

1. **다국어(i18n) 번역 버그 수정 및 질문 DB i18n 구조 추가** (이전 세션에서 작업 후 미커밋 상태였던 내용 포함)
2. **Vercel 최초 프로덕션 배포** (프로젝트 연결 → 환경변수 등록 → 배포 완료)

---

## Phase 1: 다국어 번역 버그 수정 및 질문 DB i18n 구조 추가

### 커밋: `8a93898`

### 변경 파일

| 파일 | 변경 |
|------|------|
| `src/app/[locale]/(main)/home/page.tsx` | `setRequestLocale(locale)` 추가, params Promise 타입 수정 |
| `src/app/[locale]/(main)/matches/[id]/chat/page.tsx` | 동일 |
| `src/app/[locale]/(main)/matches/page.tsx` | 동일 |
| `src/app/[locale]/(main)/missions/[id]/page.tsx` | 동일 |
| `src/app/[locale]/(main)/notifications/page.tsx` | 동일 |
| `src/app/[locale]/(main)/questions/page.tsx` | 동일 |
| `src/app/[locale]/(main)/settings/page.tsx` | 동일 |
| `src/app/[locale]/layout.tsx` | 동일 |
| `src/middleware.ts` | x-next-intl 헤더 전파 로직 추가 |
| `src/components/matches/MatchCard.tsx` | 날짜 로케일 및 태그 번역 적용 |
| `src/components/mission/MissionCard.tsx` | 날짜 로케일 적용 |
| `src/lib/constants/hobbies.ts` | 다국어 룩업 테이블 추가 |
| `src/lib/constants/personality.ts` | 다국어 룩업 테이블 추가 |
| `src/lib/constants/ideal-type.ts` | 다국어 룩업 테이블 추가 |
| `src/lib/constants/props.ts` | 다국어 룩업 테이블 추가 |
| `src/lib/constants/actions.ts` | 다국어 룩업 테이블 추가 |
| `src/actions/question.ts` | 질문 EN/JA 번역 컬럼 조회 로직 추가 |
| `src/types/database.ts` | questions 타입에 EN/JA 컬럼 추가 |
| `supabase/migrations/00028_add_question_i18n_columns.sql` | 신규: questions 테이블 EN/JA 번역 컬럼 추가 |
| `supabase/seed.sql` | EN/JA 번역 데이터 시드 추가 |

### 내용

- **next-intl v4 호환**: 모든 서버 컴포넌트 페이지에 `setRequestLocale(locale)` 추가 (정적 렌더링 지원)
- **Next.js 15 App Router 호환**: `params`를 `Promise<{ locale: string }>`으로 수정 후 `await params` 패턴 적용
- **미들웨어 헤더**: `x-next-intl-locale` 헤더를 미들웨어에서 response에 전파하여 서버 컴포넌트가 locale을 안정적으로 인식하도록 수정
- **DB 저장값 다국어 변환**: hobbies/personality/ideal_type/prop/action 값이 DB에 영어 코드로 저장되므로, locale별 표시 텍스트를 반환하는 룩업 테이블 상수 추가
- **questions 테이블 i18n**: `00028` 마이그레이션으로 `question_text_en`, `question_text_ja`, `option_a_en`, `option_a_ja`, `option_b_en`, `option_b_ja` 컬럼 추가. seed.sql에 기존 질문 전체에 대한 EN/JA 번역 데이터 추가

---

## Phase 2: 보안 파일 gitignore 처리

### 커밋: `ee4d40e`

- `*-firebase-adminsdk-*.json` 패턴을 `.gitignore`에 추가 — Firebase 서비스 계정 키 파일 실수 커밋 방지
- `openclaw-macbook-setup.md` 를 `.gitignore`에 추가 — 개인 로컬 설정 문서

---

## Phase 3: Vercel 크론 주기 임시 변경

### 커밋: `3e9331e`

Vercel Hobby 플랜은 분 단위 크론(`*/10 * * * *`)을 지원하지 않아 배포 오류 발생. 임시로 daily 주기로 변경.

| 엔드포인트 | 이전 | 변경 후 |
|------------|------|---------|
| `/api/cron/no-show` | `*/10 * * * *` (10분마다) | `10 2 * * *` (매일 새벽 2시 10분) |
| `/api/push/departure-reminder` | `*/10 * * * *` (10분마다) | `0 8 * * *` (매일 오전 8시) |

> **TODO**: Vercel Pro 업그레이드 후 원래 주기(`*/10 * * * *`)로 복원 필요

---

## Phase 4: Vercel 최초 프로덕션 배포

### 과정

1. `npx vercel login` — CLI 로그인
2. `npx vercel link` — 프로젝트 연결 (`jang-hyo-jes-projects/stranger`)
3. `npx vercel --prod` — 첫 배포 시도 → 오류 발생 (아래 참조)
4. 환경변수 17개 일괄 등록
5. `npx vercel --prod` 재시도 → 배포 성공

### 배포 URL

- 프로덕션 고정 URL: `https://stranger-alpha-livid.vercel.app`

---

## 발생한 오류 및 해결

### 오류 1: Vercel Deployment Protection (401)

**증상:** 배포 완료 후 사이트 접속 시 `401 Unauthorized` 반환

**원인:** Vercel 프로젝트의 **Deployment Protection** 기본값이 `Standard Protection`(로그인한 팀원만 접근)으로 설정되어 있음

**해결:** Vercel Dashboard → 프로젝트 → Settings → Deployment Protection → **Off** 로 변경

---

### 오류 2: MIDDLEWARE_INVOCATION_FAILED (500)

**증상:** 보호 해제 후 접속 시 `A server error has occurred — MIDDLEWARE_INVOCATION_FAILED` 반환

**원인:** Vercel에 환경변수가 전혀 등록되어 있지 않아 미들웨어(Supabase 클라이언트 초기화 등)가 실행 중 크래시

**해결:** `.env.production.local`의 환경변수 17개를 Vercel CLI로 일괄 등록

```bash
while IFS= read -r line; do
  [[ "$line" =~ ^#.*$ || -z "$line" ]] && continue
  key="${line%%=*}"
  value="${line#*=}"
  echo "$value" | npx vercel env add "$key" production --force
done < .env.production.local
```

등록된 환경변수 목록:
- `NEXT_PUBLIC_SUPABASE_URL`
- `NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY`
- `SUPABASE_SERVICE_ROLE_KEY`
- `NEXT_PUBLIC_GOOGLE_MAPS_API_KEY`
- `OPENAI_API_KEY`
- `NEXT_PUBLIC_APP_URL`
- `CRON_SECRET`
- `NEXT_PUBLIC_FIREBASE_API_KEY`
- `NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN`
- `NEXT_PUBLIC_FIREBASE_PROJECT_ID`
- `NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET`
- `NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID`
- `NEXT_PUBLIC_FIREBASE_APP_ID`
- `NEXT_PUBLIC_FIREBASE_VAPID_KEY`
- `FIREBASE_ADMIN_PROJECT_ID`
- `FIREBASE_ADMIN_CLIENT_EMAIL`
- `FIREBASE_ADMIN_PRIVATE_KEY`

---

### 오류 3: CRON_SECRET 공백 오류

**증상:** 환경변수 등록 후 재배포 시 빌드 실패

```
Error: The `CRON_SECRET` environment variable contains leading or trailing whitespace,
which is not allowed in HTTP header values.
```

**원인:** `.env.production.local` 파일에서 값을 읽을 때 줄바꿈 문자(`\n`)가 값에 포함된 채로 등록됨. `echo` 명령어는 trailing newline을 추가하므로 Vercel이 whitespace로 인식.

**해결:** `printf '%s'`를 사용해 trailing newline 없이 정확한 값만 전달

```bash
# 기존 변수 삭제
npx vercel env rm CRON_SECRET production --yes

# printf로 재등록 (trailing newline 제거)
value=$(grep "^CRON_SECRET=" .env.production.local | cut -d'=' -f2- | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
printf '%s' "$value" | npx vercel env add CRON_SECRET production --force
```

---

### 오류 4: Vercel Hobby 플랜 크론 제한

**증상:** 첫 배포 시도 시 에러

```
Hobby accounts are limited to daily cron jobs.
This cron expression (*/10 * * * *) would run more than once per day.
```

**원인:** `vercel.json`에 정의된 `/api/cron/no-show`와 `/api/push/departure-reminder`의 스케줄이 `*/10 * * * *` (10분마다)로 설정되어 있으나, Hobby 플랜은 하루 1회 이하만 허용

**해결:** 임시로 daily 주기로 변경 후 커밋/배포

> 추후 Pro 플랜 업그레이드 시 원복 필요 (Phase 3 참조)

---

## 커밋 히스토리 (오늘)

```
feat: 다국어 번역 버그 수정 및 질문 DB i18n 구조 추가   (8a93898)
chore: Firebase 서비스 계정 키 및 로컬 설정 문서 gitignore 추가   (ee4d40e)
fix: Vercel Hobby 플랜 호환을 위해 크론 주기 daily로 임시 변경   (3e9331e)
```

---

## 배포 상태

| 항목 | 내용 |
|------|------|
| 플랫폼 | Vercel (Hobby 플랜) |
| 프로덕션 URL | `https://stranger-alpha-livid.vercel.app` |
| 빌드 상태 | ✅ 성공 |
| HTTP 응답 | ✅ 200 OK |
| 환경변수 | ✅ 17개 등록 완료 |
| 크론 (expire-matches) | ✅ 매일 02:00 UTC |
| 크론 (no-show) | ⚠️ 임시 매일 02:10 (원래 10분마다 — Pro 업그레이드 후 복원 필요) |
| 크론 (departure-reminder) | ⚠️ 임시 매일 08:00 (원래 10분마다 — Pro 업그레이드 후 복원 필요) |
